# Linux-QT-RTSP 统一界面版本

## 版本信息
- **版本**: 2.1 - 统一界面版
- **更新日期**: 2024年12月
- **主要改进**: 将单路和多路模式融合到一个统一的界面中

## 主要特性

### 🎯 核心功能
- ✅ **统一界面设计**: 单一界面支持单路和多路模式无缝切换
- ✅ **智能模式切换**: 通过底部网格选择实现模式自动切换
- ✅ **多路视频支持**: 支持1-36路RTSP视频流同时播放
- ✅ **网格布局**: 6种布局模式 (1x1/2x2/3x3/4x4/5x5/6x6)
- ✅ **分页显示**: 支持超出网格容量的更多路数分页显示
- ✅ **流管理**: 动态添加/删除视频流，实时状态监控

### 🔧 技术特性
- **句柄管理系统**: 带版本号的资源管理，确保线程安全
- **独立解码线程**: 每个RTSP流使用独立线程，避免阻塞
- **信号槽机制**: 松耦合的组件通信
- **智能布局管理**: 自适应网格大小和分页

## 界面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ RTSP视频监控系统 - 统一界面                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ ┌───────────┐ ┌───────────────────────────────────────┐ ┌─────────────────┐ │
│ │   事件    │ │              视频显示区域             │ │    控制面板     │ │
│ │   消息    │ │                                       │ │                 │ │
│ │   面板    │ │  [单路模式] 或 [多路网格模式]        │ │   按钮 & 云台   │ │
│ │           │ │                                       │ │      控制       │ │
│ │   实时    │ │                                       │ │                 │ │
│ │   日志    │ │                                       │ │                 │ │
│ └───────────┘ └───────────────────────────────────────┘ └─────────────────┘ │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 网格数: ●1 ○4 ○9 ○16 ○25 ○36 | 上一页 [1] 跳转 下一页 | 添加流 移除流  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 使用方法

### 1. 单路模式（默认）
- **激活方式**: 选择底部"网格数: 1"
- **功能特性**:
  - 使用原有的单路视频播放功能
  - 支持目标检测、矩形框绘制
  - 支持截图、录制、相册管理
  - TCP网络通信功能

### 2. 多路模式
- **激活方式**: 选择底部"网格数: 4/9/16/25/36"
- **添加视频流**:
  1. 点击底部"添加流"按钮
  2. 在弹出对话框中输入RTSP地址
  3. 例如: `rtsp://192.168.1.100:554/stream`
  4. 确认后自动分配到网格中显示

- **流管理操作**:
  - **移除流**: 点击"移除流"按钮移除最近添加的流
  - **分页浏览**: 当流数量超过网格容量时使用分页控件
  - **网格切换**: 随时切换不同的网格布局

### 3. 控制面板功能
**右侧控制面板保持原有功能**:
- 添加单路视频、暂停、录制、截图、相册
- AI功能、区域识别、对象识别
- 云台控制 (上/下/左/右/复位)
- 步进控制

## 编译和运行

### 系统要求
```bash
Qt5 (5.12+)
FFmpeg开发库
OpenCV4
C++11编译器
```

### 编译步骤
```bash
cd Linux-QT-RTSP
qmake
make -j4
```

### 运行程序
```bash
./rtsp
```

## 技术架构

### 核心组件层次
```
MainWindow (主窗口)
    └── View (统一视图)
        ├── VideoLabel (单路显示)
        ├── VideoGridWidget (多路网格)
        ├── MultiStreamManager (流管理器)
        ├── MultiStreamController (流控制器)
        └── 网格控制面板
```

### 关键技术实现

#### 1. 模式切换机制
```cpp
// 通过网格选择自动切换模式
void View::onGridModeChanged() {
    bool isMultiMode = (gridNum > 1);
    setVideoDisplayMode(isMultiMode);
    // 在QStackedWidget中切换显示
    m_videoStackedWidget->setCurrentIndex(isMultiMode ? 1 : 0);
}
```

#### 2. 句柄管理系统
```cpp
// 带版本号的句柄管理
Handle encodeHandle(index, version) {
    return (version << 16) | (index & 0xFFFF);
}
```

#### 3. 多线程解码
```cpp
// 每个流独立线程
class MultiStreamDecoder : public QThread {
    void run() override; // 独立解码线程
};
```

## 使用示例

### 快速开始
1. **启动程序**: `./rtsp`
2. **单路测试**: 点击"添加"按钮，输入RTSP地址
3. **多路测试**: 
   - 选择"网格数: 4"
   - 点击"添加流"按钮
   - 输入多个不同的RTSP地址
   - 观察4宫格显示效果

### 常用操作
```
单路模式 ←→ 多路模式: 点击底部网格数选择
添加视频流: 底部"添加流"按钮 → 输入RTSP URL
切换布局: 选择不同的网格数 (1/4/9/16/25/36)
分页浏览: 使用"上一页/下一页"按钮
```

## 故障排除

### 常见问题
1. **编译错误**: 
   - 检查Qt5、FFmpeg、OpenCV依赖
   - 确认include路径配置正确

2. **视频无显示**:
   - 验证RTSP URL格式和可访问性
   - 检查网络连接状态
   - 查看左侧事件消息面板的错误信息

3. **多路模式异常**:
   - 确保选择了正确的网格数 (>1)  
   - 检查是否成功添加了视频流
   - 观察事件消息面板的状态提示

### 调试建议
- 查看左侧事件消息面板的实时日志
- 使用`qDebug()`输出查看详细信息
- 监控系统资源使用情况

## 优势特性

### 相比分离式设计的优势
1. **用户体验**: 无需在不同窗口间切换，操作更直观
2. **资源管理**: 统一的资源管理，避免重复初始化
3. **界面一致性**: 保持统一的UI风格和操作逻辑
4. **开发维护**: 单一界面代码结构，便于维护和扩展

### 设计亮点
- **智能切换**: 根据网格选择自动适配单路/多路模式
- **向后兼容**: 完整保留原有单路功能
- **扩展性强**: 支持更多网格布局的轻松扩展
- **用户友好**: 底部控制面板直观易用

## 版本历史

- **v2.1** (2024-12): 统一界面设计，融合单路和多路模式
- **v2.0** (2024-11): 独立的多路视频监控系统
- **v1.0** (2024-10): 基础单路RTSP视频播放系统

---

**项目特色**: 通过统一界面设计，实现了单路和多路视频监控的完美融合，为用户提供了更加流畅和直观的使用体验。底部网格选择控件成为模式切换的核心，使得功能切换变得自然而优雅。