# Linux-QT-RTSP 多路视频监控系统

## 项目概述

本项目是基于Qt5的RTSP视频监控系统，支持单路和多路视频流的同时播放。在原有单路功能基础上，新增了多路推流功能，支持同时接收和显示多个RTSP视频流。

## 主要功能

### 单路模式（原有功能）
- ✅ 单路RTSP视频流播放
- ✅ 视频录制和截图
- ✅ 目标检测和识别
- ✅ 矩形框绘制和标注
- ✅ TCP网络通信
- ✅ 云台控制

### 多路模式（新增功能）
- ✅ **多路同时接收**：每路独立的RTSP解码器
- ✅ **多路同时显示**：网格布局显示多路视频
- ✅ **灵活扩展**：支持1/4/9/16/25/36路显示
- ✅ **分页机制**：支持超出网格数量的更多路数显示
- ✅ **流管理**：动态添加/删除视频流
- ✅ **状态监控**：实时显示流连接状态
- ✅ **模式切换**：单路与多路模式无缝切换

## 系统架构

### 多路推流核心组件

```
MultiStreamView (用户界面)
    ├── MultiStreamController (控制层)
    │   ├── MultiStreamManager (流管理)
    │   │   └── MultiStreamDecoder (解码器)
    │   └── VideoGridWidget (显示网格)
    │       └── VideoLabel (视频标签)
    └── HandleManager (句柄管理)
```

### 关键类说明

#### 1. MultiStreamDecoder
- **功能**：单路RTSP流解码器
- **特性**：独立线程解码，支持暂停/恢复/停止
- **依赖**：FFmpeg库（libavformat, libavcodec, libswscale）

#### 2. MultiStreamManager
- **功能**：多路视频流管理器
- **特性**：基于句柄的资源管理，线程安全
- **接口**：addStream(), removeStream(), 流控制接口

#### 3. VideoGridWidget
- **功能**：网格布局视频显示组件
- **特性**：支持1x1至6x6多种布局，分页显示
- **交互**：支持视频选择和点击事件

#### 4. MultiStreamController
- **功能**：多路流控制器，协调各组件
- **特性**：流到显示的映射管理，状态维护

#### 5. MultiStreamView
- **功能**：多路模式的完整用户界面
- **特性**：流列表管理，状态监控，控制面板

## 编译和运行

### 系统要求
- Qt5 (5.12+)
- FFmpeg开发库
- OpenCV4
- C++11编译器

### 编译步骤
```bash
cd Linux-QT-RTSP
qmake
make -j4
```

### 运行程序
```bash
./rtsp
```

## 使用说明

### 模式切换
1. **菜单切换**：通过顶部菜单栏 "视图" -> "单路模式/多路模式"
2. **快捷键**：Ctrl+1（单路）/ Ctrl+2（多路）
3. **按钮切换**：多路模式下点击"返回单路"按钮

### 多路模式操作

#### 1. 添加视频流
- 在URL输入框中输入RTSP地址，如：`rtsp://192.168.1.100:554/stream`
- 点击"添加流"按钮
- 系统会自动分配显示位置并开始解码

#### 2. 布局切换
- 使用布局下拉框选择显示模式：
  - 1x1 (1路)
  - 2x2 (4路)
  - 3x3 (9路)
  - 4x4 (16路)
  - 5x5 (25路)
  - 6x6 (36路)

#### 3. 分页浏览
- 当视频流数量超出当前布局容量时，自动启用分页
- 使用"上一页/下一页"按钮或页面输入框切换页面

#### 4. 流管理
- **选择流**：点击视频画面或流列表项选择
- **移除流**：选择后点击"移除流"按钮
- **暂停/恢复**：使用"暂停所有/恢复所有"按钮
- **状态监控**：在状态面板查看连接状态和日志

## 技术特性

### 1. 多线程架构
- 每个视频流使用独立的解码线程
- UI线程与解码线程分离，保证界面响应性
- 线程安全的资源管理

### 2. 句柄管理系统
```cpp
HandleManager<MultiStreamDecoder> handleManager;
int handle = handleManager.createHandle(decoder);
MultiStreamDecoder* decoder = handleManager.getResource(handle);
```
- 带版本号的句柄避免资源竞争
- 自动资源回收和重用

### 3. 信号槽机制
```cpp
connect(decoder, &MultiStreamDecoder::frameReady, 
        this, &MultiStreamManager::onFrameReady);
```
- 松耦合的组件通信
- 事件驱动的架构设计

### 4. 智能布局管理
- 自适应网格大小计算
- 分页算法优化显示效果
- 动态布局切换无缝过渡

## 性能优化

### 1. 内存管理
- 智能指针管理解码器资源
- 帧缓存复用减少内存分配
- 及时释放无效流资源

### 2. 显示优化
- 按需刷新减少CPU占用
- 图像缩放缓存提升性能
- 跨线程图像传递优化

### 3. 网络优化
- 独立网络线程避免阻塞
- 连接状态监控和重连机制
- 错误处理和异常恢复

## 扩展功能建议

### 1. 更多路数支持
```cpp
// 可扩展到更大的网格
enum class GridLayout {
    Grid_8x8 = 64,   // 64路显示
    Grid_10x10 = 100 // 100路显示
};
```

### 2. 录制功能扩展
- 多路同时录制
- 选择性录制指定流
- 录制文件管理

### 3. 性能监控
- 帧率统计和显示
- 网络带宽监控
- 系统资源使用情况

### 4. 高级功能
- 视频流质量自适应
- 智能负载均衡
- 故障自动恢复

## 故障排除

### 常见问题

1. **编译错误**
   - 检查FFmpeg和OpenCV库是否正确安装
   - 确认头文件路径配置正确

2. **运行时崩溃**
   - 检查RTSP URL格式是否正确
   - 确认网络连接状态
   - 查看系统资源是否充足

3. **视频无显示**
   - 验证RTSP流是否可访问
   - 检查解码器格式支持
   - 查看日志输出信息

### 调试建议
- 启用qDebug输出查看详细日志
- 使用GDB调试器定位问题
- 监控系统资源使用情况

## 项目结构

```
Linux-QT-RTSP/
├── main.cpp                    # 程序入口
├── mainwindow.h/.cpp          # 主窗口（模式切换）
├── view.h/.cpp                # 单路视图
├── controller.h/.cpp          # 单路控制器
├── model.h/.cpp               # 数据模型
├── VideoLabel.h/.cpp          # 视频标签组件
├── HandleManager.h            # 句柄管理器（模板）
├── MultiStreamDecoder.h/.cpp  # 多路解码器
├── MultiStreamManager.h/.cpp  # 多路流管理器
├── VideoGridWidget.h/.cpp     # 网格布局组件
├── MultiStreamController.h/.cpp # 多路控制器
├── MultiStreamView.h/.cpp     # 多路视图
├── rtsp.pro                   # Qt项目文件
└── README.md                  # 项目说明文档
```

## 版本信息
- **版本**：2.0
- **构建时间**：2024年12月
- **Qt版本**：5.12+
- **编译器**：GCC 11+

---

本项目成功实现了从单路到多路视频监控的扩展，保持了原有功能的完整性，同时提供了强大的多路流管理能力。架构设计充分考虑了扩展性和性能，为未来的功能增强奠定了良好基础。